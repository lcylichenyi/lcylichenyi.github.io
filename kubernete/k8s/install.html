<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>0.搭建环境 | kubernete文档</title>
    <meta name="description" content="">
    <link rel="shortcut icon" href="/kubernete/favicon.ico">
    
    <link rel="preload" href="/kubernete/assets/css/0.styles.e6f0b215.css" as="style"><link rel="preload" href="/kubernete/assets/js/app.eb062e02.js" as="script"><link rel="preload" href="/kubernete/assets/js/2.663d31a2.js" as="script"><link rel="preload" href="/kubernete/assets/js/5.7077fd45.js" as="script"><link rel="prefetch" href="/kubernete/assets/js/3.f80a2313.js"><link rel="prefetch" href="/kubernete/assets/js/4.dee8ede4.js"><link rel="prefetch" href="/kubernete/assets/js/6.cbb30068.js"><link rel="prefetch" href="/kubernete/assets/js/7.08325246.js"><link rel="prefetch" href="/kubernete/assets/js/8.e94f9cac.js"><link rel="prefetch" href="/kubernete/assets/js/9.789901e0.js">
    <link rel="stylesheet" href="/kubernete/assets/css/0.styles.e6f0b215.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kubernete/" class="home-link router-link-active"><!----> <span class="site-name">kubernete文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/lcylichenyi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/kubernete/donate/" class="nav-link">捐赠</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/lcylichenyi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/kubernete/donate/" class="nav-link">捐赠</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>kubernete</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kubernete/k8s/install.html" class="active sidebar-link">安装与搭建集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_0-搭建环境" class="sidebar-link">0.搭建环境</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_1-设置http代理【如不使用代理可跳过这一步】：" class="sidebar-link">1.设置http代理【如不使用代理可跳过这一步】：</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_1-1-curl代理配置" class="sidebar-link">1.1 curl代理配置</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_1-2-docker代理配置" class="sidebar-link">1.2 docker代理配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_2-设置apt代理【如使用阿里云服务器可跳过这一步】" class="sidebar-link">2.设置apt代理【如使用阿里云服务器可跳过这一步】</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_3-安装docker" class="sidebar-link">3.安装docker</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_4-禁用swap" class="sidebar-link">4 禁用swap</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_5-安装kubelet-kubeadm-kubectl" class="sidebar-link">5.安装kubelet &amp; kubeadm &amp; kubectl</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_5-1-使用代理" class="sidebar-link">5.1 使用代理</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_5-2-不使用代理" class="sidebar-link">5.2 不使用代理</a></li></ul></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_6-获取kubeadm启动需要的镜像" class="sidebar-link">6 获取kubeadm启动需要的镜像</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_7-修改docker的cgroup驱动程序" class="sidebar-link">7 修改docker的cgroup驱动程序</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_8-直接克隆机器形成几个节点（省事）" class="sidebar-link">8 直接克隆机器形成几个节点（省事）</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_9-启动（只在master节点）" class="sidebar-link">9 启动（只在master节点）</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_10-加入-node节点" class="sidebar-link">10 加入(node节点)</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_11-检验（在master节点上）" class="sidebar-link">11 检验（在master节点上）</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_12-安装网络插件" class="sidebar-link">12 安装网络插件</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_13-修改nodeport端口范围" class="sidebar-link">13 修改nodeport端口范围</a></li><li class="sidebar-sub-header"><a href="/kubernete/k8s/install.html#_14-安装ingress-control" class="sidebar-link">14 安装ingress control</a></li></ul></li><li><a href="/kubernete/k8s/extra.html" class="sidebar-link">额外内容</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_0-搭建环境"><a href="#_0-搭建环境" class="header-anchor">#</a> 0.搭建环境</h2> <p>镜像：ubuntu-18.04.3-live-server-amd64</p> <p>身份：root（重要）</p> <p><strong>（有使用http代理和不代理两种选项，都可以走通，已测试）</strong></p> <h2 id="_1-设置http代理【如不使用代理可跳过这一步】："><a href="#_1-设置http代理【如不使用代理可跳过这一步】：" class="header-anchor">#</a> 1.设置http代理【如不使用代理可跳过这一步】：</h2> <h3 id="_1-1-curl代理配置"><a href="#_1-1-curl代理配置" class="header-anchor">#</a> 1.1 curl代理配置</h3> <div class="language-shell extra-class"><pre class="language-text"><code>vi ~/.curlrc
# 加一行 proxy=http://xxx.xxx.xxx.xxx:xx
# 然后curl 谷歌看是否正常
</code></pre></div><h3 id="_1-2-docker代理配置"><a href="#_1-2-docker代理配置" class="header-anchor">#</a> 1.2 docker代理配置</h3> <div class="language-shell extra-class"><pre class="language-text"><code>mkdir /etc/systemd/system/docker.service.d
vim /etc/systemd/system/docker.service.d/http-proxy.conf
## 复制下面内容

[Service]
Environment=&quot;HTTP_PROXY=http://xxx.xxx.xxx.xxx:xx&quot; &quot;HTTPS_PROXY=http://xxx.xxx.xxx.xxx:xx&quot;

##
systemctl daemon-reload &amp;&amp; systemctl restart docker
</code></pre></div><h2 id="_2-设置apt代理【如使用阿里云服务器可跳过这一步】"><a href="#_2-设置apt代理【如使用阿里云服务器可跳过这一步】" class="header-anchor">#</a> 2.设置apt代理【如使用阿里云服务器可跳过这一步】</h2> <p>使用阿里云的镜像：</p> <p>(https://developer.aliyun.com/mirror)[https://developer.aliyun.com/mirror]</p> <p>使用以下代码替换/etc/apt/sources.list的内容，替换前先备份（mv sources.list sources.list.bak）</p> <div class="language-shell extra-class"><pre class="language-text"><code>deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse

</code></pre></div><p>然后重启</p> <h2 id="_3-安装docker"><a href="#_3-安装docker" class="header-anchor">#</a> 3.安装docker</h2> <p>官网下载教程:</p> <p><a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/install/linux/docker-ce/ubuntu/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>（以下代码保存为shell直接运行更快）</p> <div class="language-shell extra-class"><pre class="language-text"><code>sudo apt-get remove docker docker-engine docker.io containerd runc
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo apt-key fingerprint 0EBFCD88
sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io
</code></pre></div><div class="language-shell extra-class"><pre class="language-text"><code># 成功后看是否成功
docker --version
# 然后设置开机自动启动docker
sudo systemctl enable docker
</code></pre></div><h2 id="_4-禁用swap"><a href="#_4-禁用swap" class="header-anchor">#</a> 4 禁用swap</h2> <div class="language-shell extra-class"><pre class="language-text"><code>对于禁用swap内存，具体原因可以查看Github上的Issue：Kubelet/Kubernetes should work with Swap Enabled
</code></pre></div><p><a href="https://github.com/kubernetes/kubernetes/issues/53533" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/issues/53533<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>若想永久关闭：</p> <ul><li><p>sudo vim /etc/fstab</p> <p>注释掉swap那一行</p></li> <li><p>重启</p></li></ul> <h2 id="_5-安装kubelet-kubeadm-kubectl"><a href="#_5-安装kubelet-kubeadm-kubectl" class="header-anchor">#</a> 5.安装kubelet &amp; kubeadm &amp; kubectl</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code>kubelet<span class="token punctuation">:</span>运行在cluster所有节点上<span class="token punctuation">,</span>负责启动<span class="token constant">POD</span>和容器
kubeadm<span class="token punctuation">:</span>用于初始化cluster
kubectl<span class="token punctuation">:</span><span class="token function">kubectl是kubenetes命令行工具，通过kubectl可以部署和管理应用，查看各种资源，创建，删除和更新组件</span><span class="token punctuation">(</span>node节点其实可以不用安装<span class="token punctuation">)</span>
</code></pre></div><h3 id="_5-1-使用代理"><a href="#_5-1-使用代理" class="header-anchor">#</a> 5.1 使用代理</h3> <p>方案一（官方，配置过代理推荐使用这个）</p> <p>来源：</p> <p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/tools/install-kubectl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>（以下代码保存为shell直接运行更快）</p> <div class="language-shell extra-class"><pre class="language-text"><code>sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
echo &quot;deb https://apt.kubernetes.io/ kubernetes-xenial main&quot; | sudo tee -a /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubectl kubeadm kubelet
apt-mark hold kubelet kubeadm kubectl
</code></pre></div><p>查看状态</p> <div class="language-shell extra-class"><pre class="language-text"><code>systemctl status kubelet
</code></pre></div><p>开机自启动</p> <div class="language-shell extra-class"><pre class="language-text"><code>systemctl enable kubelet
</code></pre></div><h3 id="_5-2-不使用代理"><a href="#_5-2-不使用代理" class="header-anchor">#</a> 5.2 不使用代理</h3> <p>方案二（如果没有使用代理）：</p> <p>来源：</p> <p><a href="https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.53322f70H0yumO" target="_blank" rel="noopener noreferrer">https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.53322f70H0yumO<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-shell extra-class"><pre class="language-text"><code>apt-get update &amp;&amp; apt-get install -y apt-transport-https
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - 
# 生成/etc/apt/sources.list.d/kubernetes.list文件加上一行即可
cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF

apt-get update
apt-get install -y kubelet kubeadm kubectl
apt-mark hold kubelet kubeadm kubectl
</code></pre></div><p>查看状态</p> <div class="language-shell extra-class"><pre class="language-text"><code>systemctl status kubelet
</code></pre></div><p>开机自启动</p> <div class="language-shell extra-class"><pre class="language-text"><code>systemctl enable kubelet
</code></pre></div><h2 id="_6-获取kubeadm启动需要的镜像"><a href="#_6-获取kubeadm启动需要的镜像" class="header-anchor">#</a> 6 获取kubeadm启动需要的镜像</h2> <p>方法一（使用了代理）：</p> <p>如能翻墙则直接kubeadm config images pull</p> <p>方法二（没有使用代理）：</p> <p>运行</p> <div class="language-shell extra-class"><pre class="language-text"><code>kubeadm config images list
</code></pre></div><p>获取当前版本kubeadm启动需要的镜像，像这样</p> <div class="language-shell extra-class"><pre class="language-text"><code>k8s.gcr.io/kube-apiserver:v1.17.0
k8s.gcr.io/kube-controller-manager:v1.17.0
k8s.gcr.io/kube-scheduler:v1.17.0
k8s.gcr.io/kube-proxy:v1.17.0
k8s.gcr.io/pause:3.1
k8s.gcr.io/etcd:3.4.3-0
k8s.gcr.io/coredns:1.6.5
</code></pre></div><p>然后把前缀k8s.gcr.io/ 去掉 写个像下面这样的shell脚本运行一下，用阿里云的镜像替代谷歌的镜像。</p> <div class="language-shell extra-class"><pre class="language-text"><code>#!/bin/bash
images=(
kube-apiserver:v1.17.0
kube-controller-manager:v1.17.0
kube-scheduler:v1.17.0
kube-proxy:v1.17.0
pause:3.1
etcd:3.4.3-0
coredns:1.6.5
)
for i in ${images[@]};
do
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$i
docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$i k8s.gcr.io/$i
done
</code></pre></div><h2 id="_7-修改docker的cgroup驱动程序"><a href="#_7-修改docker的cgroup驱动程序" class="header-anchor">#</a> 7 修改docker的cgroup驱动程序</h2> <p>只能使用“systemd&quot; 不然会报错</p> <div class="language-shell extra-class"><pre class="language-text"><code>vi /etc/docker/daemon.json
</code></pre></div><p>加一条</p> <div class="language-shell extra-class"><pre class="language-text"><code>&quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;]
</code></pre></div><p>随后</p> <div class="language-shell extra-class"><pre class="language-text"><code>systemctl restart docker
</code></pre></div><h2 id="_8-直接克隆机器形成几个节点（省事）"><a href="#_8-直接克隆机器形成几个节点（省事）" class="header-anchor">#</a> 8 直接克隆机器形成几个节点（省事）</h2> <p>此时可以直接克隆一下形成几个节点，因为此时的状态可以直接当作节点使用。</p> <p>如果是虚拟机中布置 在当前状态直接克隆形成几个节点改一下<strong>hostname和ip地址</strong>即可，可以省很多事。</p> <p>如果是虚拟机的话 克隆之后修改一下<strong>节点的ip</strong>（在ip许可范围内的都行，最简单的就在原来的ip上加1）</p> <p>因为我这里是ens33 这里也可能是eth0</p> <div class="language-shell extra-class"><pre class="language-text"><code># 修改ip地址
sudo ifconfig ens33 &lt;新的ip地址&gt;
sudo systemctl restart network-manager

# 修改主机名（改成啥样随意）
vi /etc/hostname

# 重启
reboot
</code></pre></div><h2 id="_9-启动（只在master节点）"><a href="#_9-启动（只在master节点）" class="header-anchor">#</a> 9 启动（只在master节点）</h2> <p>ip地址用ip addr看本机的ip地址</p> <p>kubernetes-version 就是前面kubeadm config images  看到的版本号，我这里是v1.17.0</p> <div class="language-shell extra-class"><pre class="language-text"><code>sudo kubeadm init --kubernetes-version=v1.17.0 --apiserver-advertise-address=&lt;本机的ip地址&gt;
</code></pre></div><p>如图：init成功 ，以下图仔细看，token和ip地址要记住(如果忘了也没事）</p> <div class="language-shell extra-class"><pre class="language-text"><code># 可以查看其他node join master时需要的token
kubeadm token create --print-join-command
</code></pre></div><p><img src="/kubernete/assets/img/init.77065943.png" alt="1576251497470"></p> <p>验证是否启动成功：</p> <div class="language-shell extra-class"><pre class="language-text"><code>curl https://127.0.0.1:6443 -k
</code></pre></div><p>正常结果：</p> <div class="language-shell extra-class"><pre class="language-text"><code>{
  &quot;kind&quot;: &quot;Status&quot;,
  &quot;apiVersion&quot;: &quot;v1&quot;,
  &quot;metadata&quot;: {

  },
  &quot;status&quot;: &quot;Failure&quot;,
  &quot;message&quot;: &quot;forbidden: User \&quot;system:anonymous\&quot; cannot get path \&quot;/\&quot;&quot;,
  &quot;reason&quot;: &quot;Forbidden&quot;,
  &quot;details&quot;: {

  },
  &quot;code&quot;: 403
}
</code></pre></div><p>随后</p> <div class="language-shell extra-class"><pre class="language-text"><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre></div><h2 id="_10-加入-node节点"><a href="#_10-加入-node节点" class="header-anchor">#</a> 10 加入(node节点)</h2> <div class="language-shell extra-class"><pre class="language-text"><code># 在master上查看需要在node上运行的命令
kubeadm token create --print-join-command

# 在node上运行类似这种（不要复制黏贴 用上面查看获得的）
kubeadm join 192.168.190.77:6443 --token zvj7eq.l5eenxi8ofhk3kxd \
    --discovery-token-ca-cert-hash sha256:49ceaed93cd973f6cd276cb036bd95333f4a70d7a6a588580b399fa3108002c4
</code></pre></div><h2 id="_11-检验（在master节点上）"><a href="#_11-检验（在master节点上）" class="header-anchor">#</a> 11 检验（在master节点上）</h2> <div class="language-shell extra-class"><pre class="language-text"><code>kubectl get nodes
</code></pre></div><p>这时可以看到3个NotReady的节点。 这是因为还没安装网络插件。</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYEAAABVCAYAAACvgVipAAAJ/klEQVR4nO2dW5LcIAxF26nZkve/gOk9TT5SnnITHhIS6GLuqZpKut2AEOIN8nEcx8+LkBvf39+v8zyjxSCETOArWgASz/f398dndgCE7MPBmQAhhOzLn2gBCCGExMFOgBBCNoadAKmS7hdY4/KM74rTMy5v+Uazmrw7sFqZTOsEWoq5KmCUApEKboQsmjhHpX+ep8umM6J8d5midT0Caf2NYhU9IgIxE7hXwPM8WaCLg15+6PKtiOeJMpbPXL6uBviu+LRAW0cIa89zI6T0+fU5dz49lasUxyj5JOFb+qvFnftdSb5c/lvpS/JXS78kh/SZBM0RVXT5rOTKP5cfTR5H1w8r0rozQj7v9k8rv+T5cN7v98/7/f45juP37/45faZ9Xvvu/v3931L8uf/Pkq8Wf01/td/1pJXLvzT9WtoauWv6zX1O/7zLIlK+XHiJrr1sNbr+an/TCtNrHz1pj9Bfrf2y6H/k35+QnqeCVpYe2b3zK4nPaz28N/2o+O/5lupghg3cw1rky4XtnW305iPCnp+EZ3494pqt/+yN4dWMoLaGWFpC8oq/lGZPGpF6j0pfWj7o8lkYnbfV19ifLP8M+2qxvNuI1vro6/W5fn7/LGW1TnEmkv0QSRyv15g159HyXd+la9OadC4ZV50pWpCUD7L8Elryj7R/CTCdwIxTQbUN6NHUCvgJswDPabBkc7Q3bo84Unk87Gp0R4DOrvm+E9U+hR8RTadD1rXztCOJPnMviWv1DuCKp+esuOT8ObJ8nkgGQrnnI3Q+G035IC8PaeVHyEtzJpAzzHQUJDniVFv7ksYhka/1WSufRTZrGE9GrT1KjzBK5Lp/t4t8pfTum8wSey4tqcyov5Zjmq3y8ZDPglZ/2vZntn3lOI6DXkRJP9ZGdjTo8u0OyycedgLETPRIpgW6fLvD8omFnQAhhGxM+MYwIYSQONgJEELIxrATIISQjTne7/ePZHe+djys9l3pHOxKmz9SL4Ypud+1bjen4SWnJ1beWMvlX3oD/HpWy6/E/lbQX+uy4R2JfSLmMUepfK/vW/mz2pckDq19wp1+knhO1HhllHjJW+nP6uVSo49eL5JSORD/rPnr8czaW74IOmL9+/ze0zOvNE1t/JIyi/xzWQ5CuwFHCCFExq8r6VLjnfOTsntDr5nKRegPaqq5IEj667EfJPmt5PI7ejnFO270NtPFgVx6Zbvlv2clIx11Hd0LdPkkjLYP6bX9VfXXYuX6J0G7pr9b+bf47QRKm5Cvl32JZ3XlpptM2vzMGvmvasx3+UfI3ooTXX9S+6n5D3oymvIt+R26nkvi66HWvkYjmglod8ufSm9jpTkRZGF0Yzqa6IqCqj+p/bRO5K3K3S4sZdMKj1r+o/nYGEZfu4oAXR/o8qFD/e3NzPJHbV95WYxAgVpRVuGpuvOaJdK+/ue/5aARSlp5+Sja3/cK/shHIsmf9jLP/fnq+kvllxzMuH73FCz509pXum+gtR/ETug4DnoRJYSQXeFyECGEbAw7AUII2Rh2AoQQsjHsBAghZGPYCWwI2ukEQkgcLr6DJKx6C8/LH7jGJceKekJnVft7vWy+f6TvEyi5nFgJaxnX3qOS0us6BlG30zqBlZnttXDlBov44jEIaf32CfZmnd1qGnttWulLttB0/VW6aFK7bKPx0le7aCENn7sQg4Q1/5b4tc8lDcpMQ6X92ZDorxVe0kncmZl/iX3myqgnjRHLpKms0f6xspTeslN7c0/Pm3l639YT/WaenB5m59/zearP6Ddr0f7k+pHqrKU/TV6Q7KOnLK1pWdOI1p/kr7kc1NNjefdyUL3mACwjLa1uEK+t19jd/jzcWlhnkjmZyHMQ7QnUGo2eKagm/lKasxk5jWutF7b0s1Kj3sPO9mddrivZU7pEUXruoV8Lab2DW0p5AM1OQLJjfi+g+2cpLNR/lDqamn40JxpWhPYXj1W/T+GpHZDrPYHzPJdbbtDwxLyleVo5f0+3v2io32ei7gQkbmqt7GxkkkpWe94T9kpzhZEO7U/HqKOTM/Gwzyv8KErx5wZZaHVMtDFcOoaW+3x9V4snd2SqFR4F7/xr00vDa8un1Mmg6nx3+7PKp7Uf7XMErMewPY5x14jeV2lxHAffJ0A+QRytEELGwBvDBH6kRwgZB2cChBCyMfQiSgghG8NOgBBCNmZIJ4BwrIyUYfkQQi6gNoYRT6V4ednUuIRA0wHBodf27pTCI9Y/DVb5Nbfve8sAUb8wnQDy6HR05fDoZJ4EUv7RZOkJI7Ev5PonYdSluB5fXrnfI/s++sr50tZ6GayFlYZf+Tp6LX8eF1GsXiBbZYvUCaVpW+3TGr7kz2k2pTpSujinvSxVq3+RR4gl9mltP0a2P6msKPb0Qctf+kx/9Wh+tu8y8X0C83Rdk7cn/5bw0TqRlKc0X61niLrg+wTG/329XuOuSBMZVrcAGlDLpzY6stqnh31HjeC80mzN1jVAjWKJmSl7AoiNjpaRjUBrvdDiUG4FoqfHUv1BTuWF5JZPpOEiNzVTna+qf2SmdAIsNBmlRqamvyds8kU3rtJ0o2TM7QPMlOPeAN8/78ZTOyBeFlOAupRiIc1TVP7QdRvVAJzn+fF3fSfFU6eXDMjlRPS4dwISA6ERlZFUstrznrBXmtEjHZQGJnrkjQRCeXjY5xV+FKX4c4MsNFtSv0/g+q70vPU5Df96jffn7UlP/tLfaTd+PfVfamhR9K1dGpLqvzc8YqXVYK1/Vv3OwNp+jG5/ovdVWhzHQS+i5JPVGz5CiByYG8MkDvSRHiFkHJwJEELIxvB0ECGEbAw7AUII2Ri+T2BDWD6EkAuIjWHkjUkvL5salxBI+SexlDrs9Bhr6dlOWE+1aW7f99T/nnAzCO8E0FwZ5xgtD3r+Z4OUfwRZetyGRMs8G+vsVtPYa9NC930E8T6B1WldNkr/3zuKyMWvfS5pMCINNU3bap/W8NF+jTxYuf5J7DNXxj1pjFgmTWWFtCek9wkg+tvm+wTm67omb0/+V36fQE+6qOXraRNeutKG5/sEBFh7ZG95VsDq9kADin+elNroyGoPHvYUOYKT2oe0/uxWv0gdmPcJwE2REkY2Aq31QotDuRWILnup/iI6gpI9SJfw0P3WtEh1Hm0rTwTifQIs2H+UGpmejcGViF4nlaaLaqctue4N6P0z0YFa/lbCL4utpFjUpRQLaZ6i8oeuW1Q71XpcRdczmQ/fJwCGpJLWnveEvdKMbuhQGqhUhujTUpHhEfCwzyv8KErx5wZZaIMJuPcJlH6DQk/+0t9pN3499V9qaFH0rV0akuq/N3x0pbXWH6t+VsB6DNvjGHcN9H2Z4zjoRZR8Et3wEULmEX5jmMTz9JEiIaQMZwKEELIx4aeDCCGExMFOgBBCNuYvF3Rd5knVGwsAAAAASUVORK5CYII=" alt="1576463452772"></p> <h2 id="_12-安装网络插件"><a href="#_12-安装网络插件" class="header-anchor">#</a> 12 安装网络插件</h2> <p>来源：</p> <p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>选择weave net</p> <div class="language-shell extra-class"><pre class="language-text"><code>sysctl net.bridge.bridge-nf-call-iptables=1
kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')&quot;
</code></pre></div><p>然后等待</p> <div class="language-shell extra-class"><pre class="language-text"><code>kubectl get pods --all-namespaces
</code></pre></div><p>全是running即可</p> <p>注：不加--all-namespaces则默认指明namespace=default 所以看不到</p> <h2 id="_13-修改nodeport端口范围"><a href="#_13-修改nodeport端口范围" class="header-anchor">#</a> 13 修改nodeport端口范围</h2> <div class="language-shell extra-class"><pre class="language-text"><code>vim /etc/kubernetes/manifests/kube-apiserver.yaml
# 增加一行--service-node-port-range=1-65535
# (修改完自动会更新，不需要其他操作)
</code></pre></div><p>默认值为30000-32767，如果不修改的话使用ingress时对外暴露的接口80与443会随机使用另外两个范围内的值。</p> <h2 id="_14-安装ingress-control"><a href="#_14-安装ingress-control" class="header-anchor">#</a> 14 安装ingress control</h2> <p>来源：</p> <p><a href="https://github.com/nginxinc/kubernetes-ingress/blob/master/docs/installation.md" target="_blank" rel="noopener noreferrer">https://github.com/nginxinc/kubernetes-ingress/blob/master/docs/installation.md<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-shell extra-class"><pre class="language-text"><code>kubectl apply -f common/ns-and-sa.yaml
kubectl apply -f common/default-server-secret.yaml
kubectl apply -f common/nginx-config.yaml
kubectl apply -f common/custom-resource-definitions.yaml
kubectl apply -f rbac/rbac.yaml
kubectl apply -f daemon-set/nginx-ingress.yaml

# 然后在nodeport.yaml文件中增加两个nodePort字段强制指向主机的80和443端口，而不是使用随机分配的端口
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort 
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">80 </span><span class="token comment">#新增</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">443 </span><span class="token comment">#新增</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
</code></pre></div><div class="language-shell extra-class"><pre class="language-text"><code>kubectl apply -f service/nodeport.yaml
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/kubernete/k8s/extra.html">额外内容</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/kubernete/assets/js/app.eb062e02.js" defer></script><script src="/kubernete/assets/js/2.663d31a2.js" defer></script><script src="/kubernete/assets/js/5.7077fd45.js" defer></script>
  </body>
</html>
